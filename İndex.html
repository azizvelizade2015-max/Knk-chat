<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Knk WhatsApp DM + Gruplar</title>
<style>
:root{
  --bg:#d0e7ff; --chat-bg:#e0f0ff; --panel:#0077c2; --panel-hover:#0099ff; --panel-active:#33ccff; --msg-you:#a0dfff; --msg-other:#fff;
}
body { margin:0; height:100vh; font-family:Arial,sans-serif; display:flex; justify-content:center; align-items:center; background:var(--bg); transition:background 0.3s;}
body.dark{--bg:#1c1c1c;--chat-bg:#2c2c2c;--panel:#005a87;--panel-hover:#0077b3;--panel-active:#0099cc;--msg-you:#006699;--msg-other:#444;color:white;}
.chat-container { width:800px; height:600px; background:var(--chat-bg); border-radius:12px; display:flex; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:background 0.3s;}
.sidebar { width:250px; background:var(--panel); color:white; display:flex; flex-direction:column;}
.sidebar-header { padding:14px; font-weight:bold; font-size:16px; text-align:center; border-bottom:1px solid #005fa3;}
.user-list { flex:1; overflow-y:auto;}
.user-item { padding:10px; cursor:pointer; border-bottom:1px solid #005fa3;}
.user-item:hover { background:var(--panel-hover);}
.user-item.active { background:var(--panel-active);}
.chat-panel { flex:1; display:flex; flex-direction:column; background:var(--chat-bg); transition:background 0.3s;}
.chat-header { background:var(--panel); color:white; padding:14px; font-weight:bold; font-size:16px; text-align:center; position:relative;}
.chat-header button { position:absolute; right:10px; top:8px;}
.messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; background:var(--bg); transition:background 0.3s;}
.msg { max-width:70%; padding:8px 12px; border-radius:18px; margin-bottom:8px; word-wrap:break-word; position:relative;}
.msg.you { background:var(--msg-you); align-self:flex-end;}
.msg.other { background:var(--msg-other); align-self:flex-start;}
.input-area { display:flex; padding:10px; background:#eee; gap:6px;}
body.dark .input-area{background:#333;}
input[type=text] { flex:1; padding:10px; border-radius:20px; border:none; outline:none; font-size:16px;}
button { padding:0 16px; border-radius:20px; border:none; font-weight:bold; cursor:pointer;}
#login{background:#4285f4;color:white;}
#send{background:#33ccff;color:white;}
#copy-uid{margin-left:8px;background:#005fa3;color:white;}
#profile-panel,#settings-panel,#group-panel{display:none;position:absolute;top:60px;right:20px;background:#fff;padding:12px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);width:240px;z-index:10;transition:background 0.3s;}
body.dark #profile-panel,body.dark #settings-panel,body.dark #group-panel{background:#333;color:white;}
#profile-panel input,#settings-panel select,#group-panel input,#group-panel select{width:100%;margin-bottom:8px;padding:6px;border-radius:6px;border:1px solid #ccc;}
body.dark #profile-panel input,body.dark #settings-panel select,body.dark #group-panel input,body.dark #group-panel select{border:1px solid #555;background:#555;color:white;}
.msg button{border:none;border-radius:4px;padding:2px 6px;cursor:pointer;margin-left:4px;font-size:12px;}
.msg .read-status{font-size:10px;position:absolute;bottom:-12px;right:5px;color:gray;}
</style>
</head>
<body>

<div class="chat-container">
  <div class="sidebar">
    <div class="sidebar-header" id="contacts-header">Ki≈üiler <button id="add-contact">+</button> <button id="settings-btn">‚öôÔ∏è</button> <button id="group-btn">üë•</button></div>
    <div class="user-list" id="user-list"></div>
  </div>

  <div class="chat-panel">
    <div class="chat-header">
      <span id="chat-with">Giri≈ü yap!</span>
      <button id="login">Google ile Giri≈ü</button>
      <span id="user-name" style="margin-left:10px;"></span>
      <button id="copy-uid" style="display:none;">UID Kopyala</button>
      <button id="profile-btn" style="display:none; right:100px;">Profil</button>
    </div>

    <div id="profile-panel">
      <input type="text" id="profile-name" placeholder="ƒ∞smini deƒüi≈ütir">
      <input type="file" id="profile-pic">
      <button id="save-profile">Kaydet</button>
    </div>

    <div id="settings-panel">
      <label>Karanlƒ±k Mod</label>
      <select id="dark-mode-select"><option value="off">Kapalƒ±</option><option value="on">A√ßƒ±k</option></select>
      <label>Dil</label>
      <select id="lang-select">
        <option value="az">Azerice</option>
        <option value="tr">T√ºrk√ße</option>
        <option value="en">English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>

    <div id="group-panel">
      <input type="text" id="group-name" placeholder="Grup Adƒ±">
      <label>√úyeler (maks 50 ki≈üi):</label>
      <select id="group-members" multiple size="8"></select>
      <button id="create-group">Grup Olu≈ütur</button>
    </div>

    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="message" placeholder="Mesaj yaz...">
      <input type="file" id="media-file" style="display:none;">
      <button id="attach">üìé</button>
      <button id="record-audio">üé§</button>
      <button id="send">G√∂nder</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = { apiKey:"AIzaSyDQF8lAYS7_sdOuMrX3usPuj5zYcccf4UU", authDomain:"studio-8421184642-2185b.firebaseapp.com", projectId:"studio-8421184642-2185b", storageBucket:"studio-8421184642-2185b.firebasestorage.app", messagingSenderId:"245856804046", appId:"1:245856804046:web:532a9a180b7fab330fc49f" };
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const storage=getStorage(app);
const auth=getAuth();
const provider=new GoogleAuthProvider();

let currentUser=null, currentChat=null;
const loginBtn=document.getElementById("login"), userNameSpan=document.getElementById("user-name"),
userListDiv=document.getElementById("user-list"), messagesDiv=document.getElementById("messages"),
messageInput=document.getElementById("message"), sendBtn=document.getElementById("send"),
chatWithSpan=document.getElementById("chat-with"), addContactBtn=document.getElementById("add-contact"),
copyUidBtn=document.getElementById("copy-uid"), profileBtn=document.getElementById("profile-btn"),
profilePanel=document.getElementById("profile-panel"), profileNameInput=document.getElementById("profile-name"),
profilePicInput=document.getElementById("profile-pic"), saveProfileBtn=document.getElementById("save-profile"),
attachBtn=document.getElementById("attach"), mediaFileInput=document.getElementById("media-file"),
recordAudioBtn=document.getElementById("record-audio"), settingsBtn=document.getElementById("settings-btn"),
settingsPanel=document.getElementById("settings-panel"), darkModeSelect=document.getElementById("dark-mode-select"),
langSelect=document.getElementById("lang-select"), groupBtn=document.getElementById("group-btn"),
groupPanel=document.getElementById("group-panel"), groupMembers=document.getElementById("group-members"),
groupNameInput=document.getElementById("group-name"), createGroupBtn=document.getElementById("create-group");

const usersRef=collection(db,"users"), contactsRef=collection(db,"contacts"), messagesRef=collection(db,"messages"), groupsRef=collection(db,"groups");

const messagesQuery=query(messagesRef, orderBy("time"));

// LOGIN
loginBtn.onclick=async ()=>{
  try{
    const result=await signInWithPopup(auth,provider);
    const user=result.user;
    currentUser={uid:user.uid,name:user.displayName,photo:user.photoURL};
    userNameSpan.innerText=currentUser.name; copyUidBtn.style.display="inline"; loginBtn.style.display="none"; profileBtn.style.display="inline";
    const snapshot=await getDocs(query(usersRef,where("uid","==",currentUser.uid)));
    if(snapshot.empty) await addDoc(usersRef,{uid:currentUser.uid,name:currentUser.name,photo:currentUser.photo});
    loadContacts(); loadGroups(); loadMessages();
  }catch(err){console.error(err); alert("Giri≈ü ba≈üarƒ±sƒ±z!");}
};
copyUidBtn.onclick=()=>{navigator.clipboard.writeText(currentUser.uid); alert("UID kopyalandƒ±!");};
profileBtn.onclick=()=>{profilePanel.style.display=profilePanel.style.display==="none"?"block":"none";};
settingsBtn.onclick=()=>{settingsPanel.style.display=settingsPanel.style.display==="none"?"block":"none";};
groupBtn.onclick=()=>{groupPanel.style.display=groupPanel.style.display==="none"?"block":"none";};

// PROFƒ∞L
saveProfileBtn.onclick=async ()=>{
  if(!currentUser) return;
  const snapshot=await getDocs(query(usersRef, where("uid","==",currentUser.uid)));
  if(snapshot.empty) return;
  const docRef=snapshot.docs[0].ref;
  let photoURL=currentUser.photo;
  if(profilePicInput.files.length>0){
    const file=profilePicInput.files[0];
    const storageRef=ref(storage, `profilePics/${currentUser.uid}`);
    await uploadBytes(storageRef,file);
    photoURL=await getDownloadURL(storageRef);
  }
  const newName=profileNameInput.value.trim()||currentUser.name;
  await updateDoc(docRef,{name:newName,photo:photoURL});
  currentUser.name=newName; currentUser.photo=photoURL; userNameSpan.innerText=currentUser.name; alert("Profil g√ºncellendi!");
};

// AYARLAR
darkModeSelect.onchange=()=>{document.body.classList.toggle("dark",darkModeSelect.value==="on");};
langSelect.onchange=()=>{alert("Dil se√ßildi: "+langSelect.value);};

// Kƒ∞≈ûƒ∞ EKLE
addContactBtn.onclick=async ()=>{
  if(!currentUser) return alert("√ñnce giri≈ü yap!");
  const uid=prompt("Eklemek istediƒüin ki≈üinin UID'si:"); if(!uid) return;
  const userSnap=await getDocs(query(usersRef,where("uid","==",uid))); if(userSnap.empty) return alert("B√∂yle bir kullanƒ±cƒ± yok!");
  const friendName=userSnap.docs[0].data().name;
  const existsSnap=await getDocs(query(contactsRef,where("ownerUid","==",currentUser.uid),where("friendUid","==",uid)));
  if(existsSnap.empty) await addDoc(contactsRef,{ownerUid:currentUser.uid,friendUid:uid,friendName});
  loadContacts();
};

// LOAD CONTACTS
function loadContacts(){
  onSnapshot(query(contactsRef,where("ownerUid","==",currentUser.uid)),snapshot=>{
    userListDiv.innerHTML=""; groupMembers.innerHTML="";
    snapshot.forEach(doc=>{
      const data=doc.data();
      const div=document.createElement("div"); div.className="user-item"; div.innerText=data.friendName;
      div.onclick=()=>selectChat({uid:data.friendUid,name:data.friendName},div);
      userListDiv.appendChild(div);

      const option=document.createElement("option"); option.value=data.friendUid; option.innerText=data.friendName;
      groupMembers.appendChild(option);
    });
  });
}

// CREATE GROUP
createGroupBtn.onclick=async ()=>{
  const name=groupNameInput.value.trim(); if(!name) return alert("Grup adƒ± gir!");
  const selected=[...groupMembers.selectedOptions].map(o=>o.value); if(selected.length>50) return alert("Maks 50 ki≈üi!");
  if(!selected.includes(currentUser.uid)) selected.push(currentUser.uid);
  await addDoc(groupsRef,{name,memberUids:selected});
  groupPanel.style.display="none"; groupNameInput.value=""; [...groupMembers.options].forEach(o=>o.selected=false);
  alert("Grup olu≈üturuldu!"); loadGroups();
}

// LOAD GROUPS
function loadGroups(){
  onSnapshot(groupsRef,snapshot=>{
    snapshot.docs.forEach(doc=>{
      const data=doc.data();
      if(data.memberUids.includes(currentUser.uid)){
        const exists=Array.from(userListDiv.children).some(c=>c.innerText===data.name);
        if(!exists){
          const div=document.createElement("div"); div.className="user-item"; div.innerText=data.name+" (Grup)";
          div.onclick=()=>selectChat({groupId:doc.id,name:data.name,isGroup:true,members:data.memberUids},div);
          userListDiv.appendChild(div);
        }
      }
    });
  });
}

// SELECT CHAT (DM or GROUP)
function selectChat(chatObj,divElement){
  currentChat=chatObj;
  chatWithSpan.innerText=currentChat.name;
  document.querySelectorAll('.user-item').forEach(el=>el.classList.remove('active'));
  divElement.classList.add('active');
  loadMessages();
}

// LOAD MESSAGES
function loadMessages(){
  if(!currentUser||!currentChat) return;
  onSnapshot(messagesQuery,snapshot=>{
    messagesDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const m=doc.data();
      let show=false;
      if(currentChat.isGroup){ show=m.to===currentChat.groupId; }
      else show=(m.from===currentUser.uid && m.to===currentChat.uid)||(m.from===currentChat.uid && m.to===currentUser.uid);
      if(show){
        const div=document.createElement("div"); div.className="msg"; if(m.from===currentUser.uid) div.classList.add("you"); else div.classList.add("other");
        let content="";
        if(m.mediaURL){
          if(m.mediaType.startsWith("image")) content=`<img src="${m.mediaURL}" style="max-width:200px;max-height:200px;">`;
          else if(m.mediaType.startsWith("audio")) content=`<audio controls src="${m.mediaURL}"></audio>`;
          else content=`<a href="${m.mediaURL}" target="_blank">Dosya</a>`;
        } else content=m.text;
        const favBtn=document.createElement("button"); favBtn.innerText=m.favorite?"‚≠ê":"‚òÜ"; favBtn.onclick=async e=>{e.stopPropagation(); await updateDoc(doc(db,"messages",doc.id),{favorite:!m.favorite});};
        const delBtn=document.createElement("button"); delBtn.innerText="üóëÔ∏è"; delBtn.onclick=async e=>{e.stopPropagation(); await deleteDoc(doc(db,"messages",doc.id));};
        const readStatus=document.createElement("span"); readStatus.className="read-status"; readStatus.innerText=m.readed?"‚úì‚úì":"‚úì";
        if(!currentChat.isGroup && m.to===currentUser.uid && !m.readed) updateDoc(doc(db,"messages",doc.id),{readed:true});
        div.innerHTML=`<span>${m.from===currentUser.uid?currentUser.name:"Ki≈üi"}:</span> ${content}`;
        div.appendChild(favBtn); div.appendChild(delBtn); div.appendChild(readStatus);
        messagesDiv.appendChild(div);
      }
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

// SEND MESSAGE
sendBtn.onclick=async ()=>{
  if(!currentUser) return alert("√ñnce giri≈ü yap!");
  if(!currentChat) return alert("√ñnce sohbet se√ß!");
  const text=messageInput.value.trim();
  let mediaURL=null, mediaType=null;
  if(mediaFileInput.files.length>0){
    const file=mediaFileInput.files[0];
    const storageRef=ref(storage, `chatMedia/${currentUser.uid}_${Date.now()}_${file.name}`);
    await uploadBytes(storageRef,file);
    mediaURL=await getDownloadURL(storageRef);
    mediaType=file.type;
  }
  await addDoc(messagesRef,{from:currentUser.uid,to:currentChat.isGroup?currentChat.groupId:currentChat.uid,text,time:new Date(),favorite:false,mediaURL,mediaType,readed:false});
  messageInput.valuemessageInput.value = "";
  mediaFileInput.value = "";
};

// ENTER ƒ∞LE MESAJ G√ñNDERME
messageInput.addEventListener("keydown", e => { if(e.key==="Enter") sendBtn.click(); });

// MEDIA ATTACH
attachBtn.onclick = () => mediaFileInput.click();

// SES KAYDI (basit)
recordAudioBtn.onclick = async () => {
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    return alert("Tarayƒ±cƒ±nƒ±z ses kaydƒ±nƒ± desteklemiyor!");
  }
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const mediaRecorder = new MediaRecorder(stream);
  let chunks = [];
  mediaRecorder.ondataavailable = e => chunks.push(e.data);
  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks,{type:"audio/webm"});
    const file = new File([blob],"audio_"+Date.now()+".webm",{type:"audio/webm"});
    const storageRef = ref(storage, `chatMedia/${currentUser.uid}_${Date.now()}_${file.name}`);
    await uploadBytes(storageRef,file);
    const mediaURL = await getDownloadURL(storageRef);
    await addDoc(messagesRef,{
      from: currentUser.uid,
      to: currentChat.isGroup?currentChat.groupId:currentChat.uid,
      text: "",
      time: new Date(),
      favorite:false,
      mediaURL,
      mediaType:file.type,
      readed:false
    });
  };
  mediaRecorder.start();
  alert("Ses kaydƒ± ba≈üladƒ±, durdurmak i√ßin OK'a bas.");
  await new Promise(r => setTimeout(r, 5000)); // 5 saniye kayƒ±t
  mediaRecorder.stop();
};

// FAVORƒ∞ MESAJLAR
// ≈ûu an favorite butonlarƒ± zaten loadMessages() i√ßinde ekli, kullanƒ±cƒ± tƒ±klarsa veritabanƒ±na kaydediliyor

</script>

</body>
</html>